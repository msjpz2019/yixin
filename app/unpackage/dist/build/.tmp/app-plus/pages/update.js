(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/update"],{"196e":function(e,t,n){"use strict";n.r(t);var o=n("df83"),a=n.n(o);for(var u in o)"default"!==u&&function(e){n.d(t,e,function(){return o[e]})}(u);t["default"]=a.a},a7d9:function(e,t,n){"use strict";var o=n("bf65"),a=n.n(o);a.a},bf65:function(e,t,n){},c560:function(e,t,n){"use strict";n.r(t);var o=n("fb71"),a=n("196e");for(var u in a)"default"!==u&&function(e){n.d(t,e,function(){return a[e]})}(u);n("a7d9");var s=n("2877"),r=Object(s["a"])(a["default"],o["a"],o["b"],!1,null,null,null);t["default"]=r.exports},df83:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=a(n("a34a"));function a(e){return e&&e.__esModule?e:{default:e}}function u(e,t,n,o,a,u,s){try{var r=e[u](s),i=r.value}catch(l){return void n(l)}r.done?t(i):Promise.resolve(i).then(o,a)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(o,a){var s=e.apply(t,n);function r(e){u(s,o,a,r,i,"next",e)}function i(e){u(s,o,a,r,i,"throw",e)}r(void 0)})}}var r={data:function(){return{platform:e.getSystemInfoSync().platform,current_version:100,text:"正在更新资源，请稍等",upgrade:0,downPath:[],configData:{},AppupdateUrl:"http://www.ms2018.xyz/update.json",AppdownloadUrl:"http://192.168.0.23/H5EF3C469.wgt",onlineWgt:""}},onLoad:function(){var e=s(o.default.mark(function e(){var t,n;return o.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getWidgetInfo();case 2:if(t=e.sent,this.AppupdateUrl,console.log(t," at pages/update.vue:36"),t){e.next=8;break}return console.log("无法获取本地版本"," at pages/update.vue:38"),e.abrupt("return");case 8:return e.next=10,this.$api.get("/test.php",{});case 10:n=e.sent,this.onlineWgt=n.data.wgt,this.downWgt();case 13:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}(),methods:{downWgt:function(){var e=this;console.log("正在下载资源包"," at pages/update.vue:50");var t="http://www.ms2018.xyz/".concat(this.onlineWgt),n=plus.downloader.createDownload(t,{filename:"_doc/update/"},function(t,n){200==n?(console.log("下载wgt成功："+t.filename," at pages/update.vue:54"),e.installWgt(t.filename)):console.log("下载wgt失败！"," at pages/update.vue:57")});n.addEventListener("statechanged",function(t,n){switch(t.state){case 1:break;case 2:break;case 3:var o=t.downloadedSize/t.totalSize*100;e.upgrade<parseInt(o)&&(e.upgrade=parseInt(o),console.log("upgrade"+e.upgrade," at pages/update.vue:70"));break;case 4:break}}),n.start()},installWgt:function(e){console.log("安装wgt文件..."," at pages/update.vue:80"),plus.runtime.install(e,{},function(){console.log("安装wgt文件成功！"," at pages/update.vue:82"),plus.nativeUI.alert("应用资源更新完成！",function(){plus.runtime.restart()})},function(e){console.log("安装wgt文件失败["+e.code+"]："+e.message," at pages/update.vue:87")})},versionChecked:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.current_version,n=t.split("."),o=e.split("."),a=0;a<n.length;a++){var u=+n[a],s=+o[a];if(u!=s)return!(u>s)}return!1},getConfigDownPath:function(e,t){JSON.stringify(e);var n=e["new_".concat(t)];if("undefined"!=typeof n){var o=n.length,a=parseInt(Math.random()*o),u=n[a];return"download"==t&&(this.downPath=n,this.downPath.splice(a,1)),u}return e[t]},getWidgetInfo:function(){return new Promise(function(e){plus.runtime.getProperty(plus.runtime.appid,function(t){e(t.version)})})},detectUpgrade:function(){var t=this,n=plus.downloader.createDownload(this.AppupdateUrl,{retryInterval:3,timeout:10},function(n,o){plus.downloader.clear(),200===o?plus.io.resolveLocalFileSystemURL(n.filename,function(n){n.file(function(n){var o=new plus.io.FileReader;o.readAsText(n,"utf-8"),o.onload=function(){var n=JSON.parse(o.result);if(!t.versionChecked(n.version))return console.log("不需要升级"," at pages/update.vue:153"),e.reLaunch({url:"../login/login?update=true"}),!1;plus.navigator.closeSplashscreen();var a="";if(a="android"==t.platform?n["android"]:n["iphone"],t.versionChecked(a.min_hotupdate_ver)){console.log("打开链接下载"," at pages/update.vue:175");var u=t.getConfigDownPath(a,"install");plus.runtime.openURL(u)}else console.log("热更"," at pages/update.vue:171"),t.configData=JSON.parse(JSON.stringify(n)),t.Appupdate(t.configData)},o.onerror=function(){e.showModal({title:"提示",content:"配置文件打开失败",showCancel:!1,success:function(e){plus.runtime.quit()}})}})}):e.showModal({title:"提示",content:"配置文件下载失败",showCancel:!1,success:function(e){plus.runtime.quit()}})});n.start()},Appupdate:function(t){var n=this,o=this.AppdownloadUrl,a=plus.downloader.createDownload(o,{retryInterval:3,timeout:10},function(o,a){if(n.upgrade=100,200==a){n.text="正在校验安装包是否完整";var u=plus.io.convertLocalFileSystemURL(o.filename);"iOS"==plus.os.name&&(u="file://"+u),plus.io.resolveLocalFileSystemURL(u,function(o){o.file(function(a){a.size==t.size?(n.text="正在安装，请稍后",plus.runtime.install(u,{},function(){n.text="安装完成",plus.storage.setItem("current_version",t.version),o.remove(function(){e.showModal({title:"提示",content:"资源升级完成",showCancel:!1,success:function(e){plus.runtime.restart()}})},function(){console.log("安装包删除失败"," at pages/update.vue:244")})},function(t){o.remove(function(){console.log("安装包删除成功"," at pages/update.vue:251")},function(){console.log("安装包删除失败"," at pages/update.vue:254")}),e.showToast({icon:"none",title:"安装失败了",image:"/static/img/wain.png"}),n.text="安装失败了，重启试试？",n.upgrade=0})):(o.remove(function(){console.log("安装包删除成功"," at pages/update.vue:269")},function(){console.log("安装包删除失败"," at pages/update.vue:272")}),e.showModal({title:"提示",content:"资源下载异常",success:function(e){e.confirm?(n.upgrade=0,n.text="正在检测更新，请稍后",n.detectUpgrade()):plus.runtime.quit()}}))})},function(){e.showModal({title:"提示",content:"读取升级包失败，请重试",showCancel:!1,success:function(e){plus.runtime.quit()}})})}else 0!=n.downPath.length?e.showModal({title:"提示",content:"升级包下载失败，是否重试？",success:function(e){e.confirm?n.Appupdate(n.configData):plus.runtime.quit()}}):e.showModal({title:"提示",content:"升级包下载失败，请退出重试",showCancel:!1,success:function(e){plus.runtime.quit()}})});a.addEventListener("statechanged",function(e,t){switch(e.state){case 1:break;case 2:break;case 3:var o=e.downloadedSize/e.totalSize*100;n.upgrade=parseInt(o);break;case 4:break}}),a.start()}}};t.default=r}).call(this,n("6e42")["default"])},fb71:function(e,t,n){"use strict";var o=function(){var e=this,t=e.$createElement;e._self._c},a=[];n.d(t,"a",function(){return o}),n.d(t,"b",function(){return a})}},[["a6a9","common/runtime","common/vendor"]]]);